<% layout('./layout/page'); -%>
<% block('title', 'Chat'); -%>
<p class="lead">Chat!</p>
<p>Hello, <%=user.get('username')%></p>

<script src="/socket.io/socket.io.js"></script>
<div id="room">
    <ul></ul>
    <form>
        <input disabled class="form-control" autocomplete="off" autofocus placeholder="Message...">
    </form>
</div>
<script>
    const socket = io({
        reconnectionDelay: 500,
        reconnectionDelayMax: 500,
        transports: ['websocket']
    });

    const form = $('#room form');
    const ul = $('#room ul');
    const input = $('#room input');

    socket
        .on('message', function(text) {
            $('<li>', { text: text }).appendTo(ul);
        })
        .on('connect', function() {
            console.log('CONNECTION ESTABLISHED');
            form.on('submit', sendMessage);
            input.prop('disabled', false);
        })
        .on('disconnect', function() {
            console.log('CONNECTION LOST');
            form.off('submit', sendMessage);
            input.prop('disabled', true);
        });

    function sendMessage() {
        const text = input.val();
        socket.emit('message', text);
        input.val('');
        return false;
    }

</script>
